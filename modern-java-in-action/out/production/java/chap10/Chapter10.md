# Chapter 10. 람다를 이용한 도메인 전용 언어
> Keyword : DSL, 내부 DSL, 외부 DSL, 다중 DSL, 메서드 체인, 중첩된 함수, 람다 표현식

- DSL을 API에 추가할 때의 장단점
- JVM에서 활용할 수 있는 자바 기반 DSL을 깔끔하게 만드는 대안
- 최신 자바 인터페이스와 클래스에 적용된 DSL에서 배움
- 효과적인 자바 기반 DSL을 구현하는 패턴과 기법
- 이들 패턴을 자바 라이브러리와 도구에서 얼마나 흔히 사용하는가

## 10.1 도메인 전용 언어
### DSL
- 특정 비즈니스 도메인의 문제를 해결하려고 만든 언어
- 특정 비즈니스 도메인을 인터페이스로 만든 API
- 작은, 범용이 아니라 특정 도메인을 대상으로 만들어진 특수 프로그래밍 언어
- 비즈니스 로직을 간편하게 캡슐화
- ex. Maven, Ant : 빌드 과정을 표현하는 DSL

### 장점과 단점
- 장점 : 간결함 / 가독성  / 유지보수 / 높은 수준의 추상화 / 집중 / 관심사분리
- 단점 : DSL 설계의 어려움 / 개발 비용 / 추가 우회 계층 / 새로 배워야 하는 언어 / 호스팅 언어 한계

### JVM에서 이용할 수 있는 다른 DSL 해결책
#### 내부 DSL (임베디드 DSL, internal DSL)
- 순수 자바 코드 같은 기존 호스팅 언어를 기반으로 구현
- 람다 표현식, 메서드 참조 활용
- 다른 언어의 컴파일러나 외부 DSL을 만드는 도구 사용 필요 없음 -> 추가비용 x

#### 외부 DSL (external DSL)
- 호스팅 언어와는 독립적으로 자체의 문법
- 무한한 유연성
- 새 언어를 파싱하고, 파서의 결과를 분석하고, 외부 DSL을 실행할 코드를 만들어야 한다

#### 다중 DSL 
- 같은 자바 바이트코드를 사용하는 JVM 기반 프로그래밍 언어를 이용함으로 DSL 합침 문제를 해결
- 스칼라, 루비, 코틀린, 실론, JRuby, Jython : JVM에서 실행되는 언어
- 두 개 이상의 언어가 혼재하므로 여러 컴파일러로 소스를 빌드하도록 빌드 과정을 개선해야 함
- 완벽 호환은 아님 (ex. 스칼라와 자바 컬렉션은 서로 호환되지 않음)

## 10.2 최신 자바 API의 작은 DSL
### 10.2.1 스트림  API는 컬렉션을 조작하는 DSL
- Stream은 컬렉션의 항목을 필터, 정렬, 변환, 그룹화, 조작하는 작지만 강력한 DSL로 볼 수 있다
- 스트림 API의 플루언트 형식은 잘 설계된 DSL 특징. 
- 모든 중간 연산은 게으르며 다른 연산으로 파이프라인될 수 있는 스트림으로 반환
- 최종 연산은 적극적이며 전체 파이프라인이 계산 일으킴

### 10.2.2 데이터를 수집하는 DSL인 Collectors
- Collector 인터페이스는 데이터 수집을 수행하는 DSL

## 10.3 자바로 DSL을 만드는 패턴과 기법
### 10.3.1 메서드 체인
#### 장점
- 플루언트 방식
- 메서드 이름이 키워드 인수 역할을 한다.
- 선택형 파라미터와 잘 동작한다.
- DSL 사용자가 정해진 순서로 메서드를 호출하도록 강제할 수 있다.
- 정적 메서드를 최소화하거나 없앨 수 있다.
- 문법적 잡음을 최소화한다.
#### 단점
- 구현이 장황하다.
- 빌드를 연결하는 접착 코드가 필요하다.
- 들여쓰기 규칙으로만 도메인 객체 계층을 정의한다.
### 10.3.2 중첩된 함수  이용
- 다른 함수 안에 함수를 이용해 도메인 모델 만듦
#### 장점
- 구현의 장황함을 줄일 수 있다.
- 함수 중첩으로 도메인 객체 계층을 반영한다.
#### 단점
- 정적 메서드의 사용이 빈번하다.
- 이름이 아닌 위치로 인수를 정의한다.
- 선택형 파라미터를 처리할 메서드 오버로딩이 필요하다
### 10.3.3 람다 표현식을 이용한 함수 시퀀싱
- 람다 표현식으로 정의한 함수 시퀀스 사용
- 메서드 체인 과 중첩된 함수 DSL 형식의 장점을 더함.
#### 장점
- 선택형 파라미터와 잘 동작한다.
- 정적 메서드를 최소화하거나 없앨 수 있다.
- 람다 중첩으로 도메인 객체 계층을 반영한다.
- 빌더의 접착 코드가 없다.
#### 단점
- 구현이 장황하다.
- 람다 표현식으로 인한 문법적 잡음이 DSL에 존재한다
### 10.3.4 조합하기
- 메서드 체인 / 중첩된 함수 / 람다 3가지를 자유롭게 조합

### 10.3.5 DSL에 메서드 참조 사용하기
일반 메서드 -> 메서드 체인 / 중첩된 함수 / 람다 표현식 -> 메서드 참조

## 10.4 실생활의 자바 8 DSL
### 10.4.1 jOOQ (SQL 매핑 도구) - 메서드 체인
- SQL을 구현하는 내부적 DSL로 자바에 직접 내장된 형식 안전 언어
```java
SELECT * FROM BOOK 
        WHERE BOOK.PUBLISHED_IN = 2016
        ORDER BY BOOK.TITLE
        
create.selectFrom(BOOK)
 .where(BOOK.PUBLISHED_IN.eq(2016))
 .orderBy(BOOK.TITLE)
```
### 10.4.2 큐컴버 (동작 주도 개발 프레임워크) - 외부 DSL
- 메서드 체인 패턴(BDD)은 테스트 주도 개발의 확장으로 다양한 비즈니스 시나리오를 구조적으로 서술하는 간단한 도메인 전용 스크립팅 언어를 사용
- 큐컴버는 다른 BDD 프레임워크와 마찬가지로 이들 명령문을 실행할 수 있는 테스트 케이스로 변환
- 스크립트 결과물은 실행할 수 있는 테스트임과 동시에 비즈니스 기능의 수용 기준
#### 큐컴버 3가지 개념
전제 조건 정의(Given), 시험하려는 도메인 객체의 실질 호출(When), 테스트 케이스의 결과를 확인하는 어설션 (Then)
```java
@Given("^the price of a \"(.*?)\" stock is (\\d+)\\$$")
@When("^I buy (\\d+) \"(.*?)\"$")
@Then("^the order value should be (\\d+)\\$$")
```
### 10.4.3 스프링 통합 (엔터프라이즈 통합 패턴) - 메서드 체인
- 유명한 엔터프라이즈 통합 패턴을 지원할 수 있도록 의존성 주입에 기반한 스프링 프로그래밍 모델을 확장
- 스프링 기반 애플리케이션 내의 경량의 원격, 메시징, 스케쥴링을 지원
- 목표 : 복잡한 엔터프라이즈 통합 솔루션을 구현하는 단순한 모델을 제공하고 비동기, 메시지 주도 아키텍처를 쉽게 적용할 수 있게 돕는 것

## 10.5 마치며
- DSL의 주요 기능은 개발자와 도메인 전문가 사이의 간격을 좁히는 것. 애플리케이션의 비즈니스 로직을 구현하는 코드를 만든 사람이 프로그램이 사용될 비즈니스 필드의 전문 지식을 갖추긴 어렵다. 개발자가 아닌 사람도 이해할 수 있는 언어로 이런 비즈니스 로직을 구현할 수 있다고 해서 도메인 전문가가 프로그래머가 될 수 있는 것은 아니지만 적어도 로직을 읽고 검증하는 역할은 할 수 있다.
- DSL은 크게 내부적(DSL이 사용될 애플리케이션을 개발한 언어를 그대로 활용) DSL과 외부적(직접 언어를 설계해 사용함) DSL로 분류할 수 있다. 내부적 DSL은 개발 노력이 적게 드는 반면 호스팅 언어의 문법 제약을 받는다. 외부적 DSL은 높은 유연성을 제공하지만 구현하기가 어렵다.
- JVM에서 이용할 수 있는 스칼라, 그루비 등의 다른 언어로 다중 DSL을 개발할 수 있다. 이들 언어는 자바보다 유연하며 간결한 편이다. 하지만 이들을 자바와 통합하려면 빌드 과정이 복잡해지며 자바와의 상호 호환성 문제도 생길 수 있다.
- 자바의 장황함과 문법적 엄격함 때문에 보통 자바는 내부적 DSL을 개발하는 언어로는 적합하지 않다. 하지만 자바 8의 람다 표현식과 메서드 참조 덕분에 상황이 많이 개선되었다
- 최신 자바는 자체 API에 작은 DSL을 제공한다. 이들 Stream, Collectors 클래스 등에서 제공하는 작은 DSL은 특히 컬렉션 데이터의 정렬, 필터링, 변환, 그룹화에 유용하다
- 자바로 DSL을 구현할 때 보통 메서드 체인, 중첩 함수, 함수 시퀀싱 세 가지 패턴이 사용된다. 각각의 패턴은 장단점이 있지만 모든 기법을 한 개의 DSL에 합쳐 장점만을 누릴 수 있다.
- 많은 자바 프레임워크와 라이브러리를 DSL을 통해 이용할 수 있다. 10장에서는 SQL 매핑 도구인 jOOQ, BDD 프레임워크 큐컴버, 엔터프라이즈 통합 패턴을 구현한 스프링 확장인 스프링 통합을 살펴봤다

